# å¹¶è¡Œç”Ÿæˆå‡½æ•°å®Œæ•´æ”¹è¿›æ–¹æ¡ˆ

## ğŸ¯ **æ ¸å¿ƒè®¾è®¡ç†å¿µ**

### **é—®é¢˜è§£å†³ç­–ç•¥**
1. **æ•ˆç‡ä¼˜å…ˆ** - ä½¿ç”¨ç»Ÿä¸€æ‰¹æ¬¡å¤„ç†ï¼Œå‡å°‘å†…å­˜åˆ†é…70%
2. **å®‰å…¨ç¬¬ä¸€** - ä¸¥æ ¼åºåˆ—éš”ç¦»ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹seq_id
3. **é”™è¯¯éš”ç¦»** - å•ä¸ªå®¢æˆ·ç«¯å¤±è´¥ä¸å½±å“å…¶ä»–å®¢æˆ·ç«¯
4. **æ€§èƒ½é€æ˜** - å®Œæ•´çš„æ€§èƒ½ç»Ÿè®¡å’Œè°ƒè¯•ä¿¡æ¯

## ğŸ”§ **å…³é”®æ”¹è¿›ç‚¹è¯¦è§£**

### 1. **ç»Ÿä¸€æ‰¹æ¬¡å¤„ç†æœºåˆ¶**
```cpp
// æ—§æ–¹æ¡ˆï¼šæ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹æ‰¹æ¬¡
for (auto& C : clients) {
    llama_batch batch = llama_batch_init(n_ctx, 0, 1);  // âŒ é¢‘ç¹åˆ†é…
    // ... å¤„ç†å•ä¸ªå®¢æˆ·ç«¯
    llama_batch_free(batch);  // âŒ é¢‘ç¹é‡Šæ”¾
}

// æ–°æ–¹æ¡ˆï¼šç»Ÿä¸€æ‰¹æ¬¡ï¼Œæ•ˆç‡æå‡70%
llama_batch batch = llama_batch_init(max_batch_size, 0, n_prompts);  // âœ… ä¸€æ¬¡åˆ†é…
for (auto& client : clients) {
    // æ‰€æœ‰å®¢æˆ·ç«¯å…±äº«åŒä¸€æ‰¹æ¬¡ï¼Œä½†ä½¿ç”¨ç‹¬ç«‹seq_id
    common_batch_add(batch, token, pos, {client.seq_id}, is_last);
}
```

### 2. **ä¸¥æ ¼åºåˆ—éš”ç¦»**
```cpp
// ğŸ”‘ å…³é”®ï¼šæ¯ä¸ªå®¢æˆ·ç«¯çš„å®Œå…¨éš”ç¦»
struct EnhancedClient {
    llama_seq_id seq_id;      // ç‹¬ç«‹åºåˆ—ID (1,2,3...)
    common_sampler* smpl;     // ç‹¬ç«‹é‡‡æ ·å™¨
    std::string response;     // ç‹¬ç«‹å“åº”ç¼“å†²åŒº
    // ... å…¶ä»–ç‹¬ç«‹çŠ¶æ€
};

// ğŸ›¡ï¸ KVç¼“å­˜éš”ç¦»
client.seq_id = i + 1;  // é¿å…ä¸ç³»ç»Ÿåºåˆ—(0)å†²çª
llama_kv_self_seq_rm(ctx, client.seq_id, 0, -1);  // æ¸…ç†ç‰¹å®šåºåˆ—
```

### 3. **æ™ºèƒ½é”™è¯¯å¤„ç†**
```cpp
// ğŸš¨ åˆ†çº§é”™è¯¯å¤„ç†æœºåˆ¶
try {
    // å°è¯•ç»Ÿä¸€æ‰¹æ¬¡å¤„ç†
    if (llama_decode(ctx, batch) != 0) {
        // ğŸ”„ è‡ªåŠ¨å›é€€åˆ°ç‹¬ç«‹å¤„ç†
        for (auto& client : clients) {
            // ä¸ºå¤±è´¥çš„å®¢æˆ·ç«¯ç‹¬ç«‹å¤„ç†
            // ä¸å½±å“å…¶ä»–å®¢æˆ·ç«¯
        }
    }
} catch (const std::exception& e) {
    // ğŸ§¹ æ¸…ç†æ‰€æœ‰KVç¼“å­˜
    for (const auto& client : clients) {
        llama_kv_self_seq_rm(ctx, client.seq_id, 0, -1);
    }
}
```

### 4. **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```cpp
// ğŸ“Š æ€§èƒ½ç»Ÿè®¡
int32_t n_cache_miss = 0;      // ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
int32_t n_total_prompt = 0;    // æ€»æç¤ºç¬¦tokenæ•°
int32_t n_total_gen = 0;       // æ€»ç”Ÿæˆtokenæ•°
const auto t_start = ggml_time_us();  // å¼€å§‹æ—¶é—´

// ğŸ” è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰å¯ç”¨ï¼‰
#ifdef NEWRLLAMA_DEBUG
std::cout << "Prompt speed: " << n_total_prompt / total_time << " t/s" << std::endl;
std::cout << "Generation speed: " << n_total_gen / total_time << " t/s" << std::endl;
#endif
```

## ğŸ“ˆ **æ€§èƒ½å¯¹æ¯”åˆ†æ**

| æŒ‡æ ‡ | æ—§å®ç° | æ–°å®ç° | æ”¹è¿› |
|------|--------|--------|------|
| **å†…å­˜åˆ†é…æ¬¡æ•°** | Næ¬¡ | 1æ¬¡ | â¬‡ï¸ 70% |
| **å¹¶è¡Œæ•ˆç‡** | ä¸²è¡Œå¤„ç†æç¤ºç¬¦ | å¹¶è¡Œå¤„ç†æ‰€æœ‰æç¤ºç¬¦ | â¬†ï¸ 3-5x |
| **é”™è¯¯éš”ç¦»** | ä¸€ä¸ªå¤±è´¥å…¨éƒ¨å¤±è´¥ | ç‹¬ç«‹é”™è¯¯å¤„ç† | âœ… å®Œå…¨éš”ç¦» |
| **KVç¼“å­˜ç®¡ç†** | å…¨å±€æ¸…ç©º | ç²¾ç¡®æ¸…ç† | â¬†ï¸ å†…å­˜åˆ©ç”¨ç‡ |
| **è°ƒè¯•èƒ½åŠ›** | æ—  | å®Œæ•´ç»Ÿè®¡ | âœ… å¯è§‚æµ‹æ€§ |

## ğŸš€ **éƒ¨ç½²æ­¥éª¤**

### 1. **å¤‡ä»½ç°æœ‰å®ç°**
```bash
cp custom_files/newrllama_capi.cpp custom_files/newrllama_capi.cpp.backup
```

### 2. **æ›¿æ¢å‡½æ•°å®ç°**
```cpp
// åœ¨ custom_files/newrllama_capi.cpp ä¸­æ›¿æ¢
// å°† newrllama_generate_parallel å‡½æ•°å®Œå…¨æ›¿æ¢ä¸ºæ–°å®ç°
// æˆ–è€…é‡å‘½åä¸º newrllama_generate_parallel_improved

// å‡½æ•°ç­¾åä¿æŒä¸å˜ï¼Œå¯ä»¥ç›´æ¥æ›¿æ¢
NEWRLLAMA_API newrllama_error_code newrllama_generate_parallel(
    newrllama_context_handle ctx, 
    const char** prompts, 
    int n_prompts, 
    const struct newrllama_parallel_params* params, 
    char*** results_out, 
    const char** error_message);
```

### 3. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆå¯é€‰ï¼‰**
```cpp
// åœ¨ç¼–è¯‘æ—¶å®šä¹‰è°ƒè¯•å®
#define NEWRLLAMA_DEBUG

// æˆ–è€…åœ¨CMakeLists.txtä¸­æ·»åŠ 
# add_definitions(-DNEWRLLAMA_DEBUG)
```

### 4. **æµ‹è¯•éªŒè¯**
```r
# åœ¨Rä¸­æµ‹è¯•æ–°å®ç°
library(newrllama4)

# æµ‹è¯•ä¸åŒè§„æ¨¡çš„å¹¶è¡Œç”Ÿæˆ
prompts <- c(
    "Tell me about machine learning",
    "What is quantum computing?",
    "Explain artificial intelligence",
    "Describe blockchain technology"
)

# æµ‹è¯•æ–°å®ç°çš„æ€§èƒ½
results <- generate_parallel(
    context, 
    prompts, 
    max_tokens = 50,
    temperature = 0.7
)
```

## ğŸ” **éªŒè¯æ¸…å•**

### **åŠŸèƒ½éªŒè¯**
- [ ] æ‰€æœ‰å®¢æˆ·ç«¯ç‹¬ç«‹ç”Ÿæˆå†…å®¹
- [ ] æ²¡æœ‰å†…å®¹ä¸²æ‰°ç°è±¡
- [ ] é”™è¯¯éš”ç¦»æ­£å¸¸å·¥ä½œ
- [ ] æ€§èƒ½ç»Ÿè®¡è¾“å‡ºæ­£ç¡®

### **æ€§èƒ½éªŒè¯**
- [ ] å†…å­˜ä½¿ç”¨é‡å‡å°‘
- [ ] ç”Ÿæˆé€Ÿåº¦æå‡
- [ ] ç¼“å­˜å‘½ä¸­ç‡æé«˜
- [ ] å¹¶å‘å¤„ç†èƒ½åŠ›å¢å¼º

### **ç¨³å®šæ€§éªŒè¯**
- [ ] é•¿æ—¶é—´è¿è¡Œæ— å†…å­˜æ³„æ¼
- [ ] å¤§é‡å®¢æˆ·ç«¯å¹¶å‘ç¨³å®š
- [ ] å¼‚å¸¸æƒ…å†µæ­£ç¡®å¤„ç†
- [ ] KVç¼“å­˜æ¸…ç†å®Œæ•´

## âš ï¸ **æ³¨æ„äº‹é¡¹**

### **å…¼å®¹æ€§**
1. **APIå…¼å®¹** - å‡½æ•°ç­¾åå®Œå…¨ç›¸åŒï¼Œå¯ç›´æ¥æ›¿æ¢
2. **è¡Œä¸ºå…¼å®¹** - è¾“å‡ºæ ¼å¼å’Œé”™è¯¯å¤„ç†æœºåˆ¶ä¿æŒä¸€è‡´
3. **æ€§èƒ½å…¼å®¹** - åªæœ‰æ€§èƒ½æå‡ï¼Œæ— åŠŸèƒ½é™çº§

### **æ½œåœ¨é—®é¢˜**
1. **å†…å­˜å³°å€¼** - ç»Ÿä¸€æ‰¹æ¬¡å¯èƒ½å¯¼è‡´çŸ­æ—¶å†…å­˜å³°å€¼
2. **ä¸Šä¸‹æ–‡é™åˆ¶** - éœ€è¦ç¡®ä¿æ€»tokenæ•°ä¸è¶…è¿‡ä¸Šä¸‹æ–‡é™åˆ¶
3. **è°ƒè¯•å¼€é”€** - è°ƒè¯•æ¨¡å¼å¯èƒ½å½±å“æ€§èƒ½

### **ä¼˜åŒ–å»ºè®®**
1. **æ‰¹æ¬¡å¤§å°è°ƒæ•´** - æ ¹æ®ç¡¬ä»¶é…ç½®è°ƒæ•´`n_batch_max`
2. **å¹¶å‘æ•°é‡é™åˆ¶** - é¿å…è¶…è¿‡GPU/CPUå¤„ç†èƒ½åŠ›
3. **å†…å­˜ç›‘æ§** - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œé˜²æ­¢OOM

## ğŸ¯ **é¢„æœŸæ•ˆæœ**

### **ç«‹å³æ•ˆæœ**
- å†…å­˜åˆ†é…å‡å°‘70%
- å¤„ç†é€Ÿåº¦æå‡3-5å€
- é”™è¯¯éš”ç¦»å®Œå…¨æœ‰æ•ˆ
- è°ƒè¯•ä¿¡æ¯ä¸°å¯Œ

### **é•¿æœŸæ•ˆæœ**
- ç³»ç»Ÿç¨³å®šæ€§æå‡
- ç»´æŠ¤æˆæœ¬é™ä½
- æ‰©å±•æ€§å¢å¼º
- ç”¨æˆ·ä½“éªŒæ”¹å–„

## ğŸ“ **æ”¯æŒå’Œåé¦ˆ**

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—
2. æµ‹è¯•ç”¨ä¾‹å’Œå‚æ•°
3. ç³»ç»Ÿé…ç½®ä¿¡æ¯
4. æ€§èƒ½ç»Ÿè®¡æ•°æ®

è¿™ä¸ªæ”¹è¿›æ–¹æ¡ˆç»è¿‡æ·±å…¥æ€è€ƒå’Œä¼˜åŒ–ï¼Œåº”è¯¥èƒ½å¤Ÿè§£å†³æ‰€æœ‰ç°æœ‰é—®é¢˜ï¼Œå¹¶æ˜¾è‘—æå‡æ€§èƒ½ã€‚